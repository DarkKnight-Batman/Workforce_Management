<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workforce & Capacity Planning Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Chart Container Specifics */
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 font-sans antialiased selection:bg-indigo-100 selection:text-indigo-800">

    <!-- Chosen Palette: Warm Neutrals with Indigo/Emerald/Rose Accents
         Background: Stone-50
         Text: Stone-800
         Primary Action: Indigo-600
         Success: Emerald-600
         Danger: Rose-600
    -->

    <!-- Application Structure Plan:
         1.  **Sidebar Navigation**: Context switching between 'Overview', 'Capacity Planner' (Simulator), and 'Bench Analytics'.
         2.  **Top Bar**: Global Filters (Branch, Stream) acting as the main slicers described in the Power BI blueprint.
         3.  **Dashboard Area**: Dynamic grid layout.
             -   **Overview**: High-level KPIs (Headcount, Capacity, Gap) and a breakdown Matrix.
             -   **Planner**: The "What-If" simulator for incoming roles.
             -   **Bench**: Specific focus on Bench utilization gauge.
         4.  **Data Logic**: JavaScript objects simulate the Star Schema (Dim_Employee, Fact_Recruiting, etc.) to perform client-side aggregations identical to the DAX measures.
    -->

    <!-- Visualization & Content Choices:
         1.  **KPI Cards**: Simple text/number display for immediate status. Goal: Inform.
         2.  **Cluster Bar Chart**: Comparing Capacity vs. Load per Branch. Goal: Compare. Library: Chart.js.
         3.  **Interactive Matrix**: HTML Table with conditional formatting (Red/Green backgrounds) for the 'Bandwidth Gap'. Goal: Organize & Inform.
         4.  **Gauge Chart**: Doughnut chart (Chart.js) to show Bench Utilization %. Goal: Relationships/Status.
         5.  **Simulator Slider**: HTML Range input to replicate the Power BI 'What-If' parameter. Goal: Change/Predict.
    -->

    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-stone-200 hidden md:flex flex-col z-10">
            <div class="p-6 border-b border-stone-100">
                <h1 class="text-xl font-bold text-indigo-900 tracking-tight">Workforce<span class="text-indigo-600">.bi</span></h1>
                <p class="text-xs text-stone-500 mt-1">Capacity Planning System</p>
            </div>
            
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="switchTab('overview')" id="nav-overview" class="w-full flex items-center space-x-3 px-4 py-3 bg-indigo-50 text-indigo-700 rounded-lg font-medium transition-colors">
                    <span>üìä</span>
                    <span>Operations Overview</span>
                </button>
                <button onclick="switchTab('planner')" id="nav-planner" class="w-full flex items-center space-x-3 px-4 py-3 text-stone-600 hover:bg-stone-50 rounded-lg font-medium transition-colors">
                    <span>üßÆ</span>
                    <span>Bandwidth Planner</span>
                </button>
                <button onclick="switchTab('bench')" id="nav-bench" class="w-full flex items-center space-x-3 px-4 py-3 text-stone-600 hover:bg-stone-50 rounded-lg font-medium transition-colors">
                    <span>üë•</span>
                    <span>Bench Analytics</span>
                </button>
            </nav>

            <div class="p-4 border-t border-stone-100">
                <div class="bg-stone-100 rounded-lg p-3">
                    <p class="text-xs font-semibold text-stone-600 uppercase mb-1">Data Source</p>
                    <p class="text-xs text-stone-500">Live Simulation (Browser)</p>
                    <p class="text-xs text-stone-400 mt-1">Last update: Just now</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden relative">
            
            <!-- Mobile Header -->
            <div class="md:hidden bg-white border-b border-stone-200 p-4 flex justify-between items-center">
                <h1 class="text-lg font-bold text-indigo-900">Workforce.bi</h1>
                <button onclick="toggleMobileMenu()" class="text-stone-600">‚ò∞</button>
            </div>

            <!-- Filters Bar -->
            <header class="bg-white border-b border-stone-200 p-4 shadow-sm z-20">
                <div class="max-w-7xl mx-auto flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h2 id="page-title" class="text-lg font-semibold text-stone-800">Operations Overview</h2>
                        <p class="text-sm text-stone-500">Global filters apply to all views.</p>
                    </div>
                    
                    <div class="flex flex-wrap gap-3">
                        <!-- Branch Slicer -->
                        <div class="relative">
                            <label for="branch-select" class="block text-xs font-medium text-stone-400 uppercase mb-1">Branch</label>
                            <select id="branch-select" onchange="updateDashboard()" class="block w-40 pl-3 pr-8 py-2 text-sm border border-stone-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 rounded-md bg-stone-50">
                                <option value="All">All Branches</option>
                                <!-- Populated by JS -->
                            </select>
                        </div>

                        <!-- Stream Slicer -->
                        <div class="relative">
                            <label for="stream-select" class="block text-xs font-medium text-stone-400 uppercase mb-1">Stream</label>
                            <select id="stream-select" onchange="updateDashboard()" class="block w-40 pl-3 pr-8 py-2 text-sm border border-stone-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 rounded-md bg-stone-50">
                                <option value="All">All Streams</option>
                                <!-- Populated by JS -->
                            </select>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto bg-stone-50 p-4 md:p-8" id="main-scroll">
                <div class="max-w-7xl mx-auto space-y-8">

                    <!-- VIEW: OVERVIEW -->
                    <div id="view-overview" class="space-y-6 animate-fade">
                        <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded-r-md">
                            <p class="text-sm text-indigo-900">
                                <strong>Welcome to the Command Center.</strong> This view aggregates data across all branches to show total capacity vs. current workload.
                                <em>Note: Capacity is calculated based on a recruiter handling only 3 roles per day.</em>
                            </p>
                        </div>

                        <!-- KPI Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-white p-5 rounded-xl border border-stone-200 shadow-sm">
                                <p class="text-xs font-bold text-stone-400 uppercase tracking-wider">Total Headcount</p>
                                <div class="flex items-baseline mt-2">
                                    <span class="text-2xl font-bold text-stone-800" id="kpi-headcount">0</span>
                                    <span class="ml-2 text-xs font-medium text-stone-500">Recruiters</span>
                                </div>
                            </div>
                            <div class="bg-white p-5 rounded-xl border border-stone-200 shadow-sm">
                                <p class="text-xs font-bold text-stone-400 uppercase tracking-wider">Total Capacity</p>
                                <div class="flex items-baseline mt-2">
                                    <span class="text-2xl font-bold text-indigo-600" id="kpi-capacity">0</span>
                                    <span class="ml-2 text-xs font-medium text-stone-500">Units</span>
                                </div>
                            </div>
                            <div class="bg-white p-5 rounded-xl border border-stone-200 shadow-sm">
                                <p class="text-xs font-bold text-stone-400 uppercase tracking-wider">Current Load</p>
                                <div class="flex items-baseline mt-2">
                                    <span class="text-2xl font-bold text-stone-800" id="kpi-load">0</span>
                                    <span class="ml-2 text-xs font-medium text-stone-500">Roles + Bench</span>
                                </div>
                            </div>
                            <div class="bg-white p-5 rounded-xl border border-stone-200 shadow-sm" id="kpi-gap-card">
                                <p class="text-xs font-bold text-stone-400 uppercase tracking-wider">Bandwidth Gap</p>
                                <div class="flex items-baseline mt-2">
                                    <span class="text-2xl font-bold" id="kpi-gap">0</span>
                                    <span class="ml-2 text-xs font-medium text-stone-500">Available</span>
                                </div>
                            </div>
                        </div>

                        <!-- Main Chart Row -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 bg-white p-6 rounded-xl border border-stone-200 shadow-sm">
                                <h3 class="text-md font-bold text-stone-800 mb-4">Capacity vs. Load by Branch</h3>
                                <div class="chart-container">
                                    <canvas id="mainBarChart"></canvas>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl border border-stone-200 shadow-sm flex flex-col">
                                <h3 class="text-md font-bold text-stone-800 mb-4">Utilization Breakdown</h3>
                                <div class="flex-1 flex items-center justify-center chart-container">
                                    <canvas id="utilizationPieChart"></canvas>
                                </div>
                                <div class="mt-4 text-center">
                                    <p class="text-xs text-stone-500">Displays proportion of used vs. available capacity.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Data Matrix -->
                        <div class="bg-white rounded-xl border border-stone-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-stone-100 flex justify-between items-center">
                                <h3 class="text-md font-bold text-stone-800">Detailed Capacity Matrix</h3>
                                <span class="text-xs px-2 py-1 bg-stone-100 text-stone-600 rounded">Live Data</span>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-stone-50 text-stone-500 uppercase text-xs">
                                        <tr>
                                            <th class="px-6 py-3 font-medium">Branch</th>
                                            <th class="px-6 py-3 font-medium">Stream</th>
                                            <th class="px-6 py-3 font-medium">Category</th>
                                            <th class="px-6 py-3 font-medium text-right">Headcount</th>
                                            <th class="px-6 py-3 font-medium text-right">Capacity</th>
                                            <th class="px-6 py-3 font-medium text-right">Load</th>
                                            <th class="px-6 py-3 font-medium text-center">Gap</th>
                                        </tr>
                                    </thead>
                                    <tbody id="matrix-body" class="divide-y divide-stone-100 text-stone-700">
                                        <!-- JS Populated -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- VIEW: PLANNER -->
                    <div id="view-planner" class="space-y-6 hidden">
                        <div class="bg-emerald-50 border-l-4 border-emerald-500 p-4 rounded-r-md">
                            <p class="text-sm text-emerald-900">
                                <strong>Strategic Planning Simulator.</strong> Adjust the slider to simulate adding new roles. 
                                Hiring needs are calculated based on a maximum capacity of 3 roles per recruiter.
                            </p>
                        </div>

                        <div class="bg-white p-8 rounded-xl border border-stone-200 shadow-sm">
                            <div class="flex flex-col md:flex-row gap-10 items-start">
                                <div class="w-full md:w-1/2 space-y-6">
                                    <div>
                                        <label for="roles-slider" class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-bold text-stone-700 uppercase">Incoming Roles / Contracts</span>
                                            <span class="px-3 py-1 bg-indigo-100 text-indigo-700 font-bold rounded text-sm" id="slider-value-display">0 Roles</span>
                                        </label>
                                        <input type="range" id="roles-slider" min="0" max="200" step="5" value="0" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                                        <div class="flex justify-between text-xs text-stone-400 mt-2">
                                            <span>0</span>
                                            <span>50</span>
                                            <span>100</span>
                                            <span>150</span>
                                            <span>200+</span>
                                        </div>
                                    </div>

                                    <div class="p-4 bg-stone-50 rounded-lg border border-stone-200">
                                        <h4 class="text-xs font-bold text-stone-500 uppercase mb-2">Current Context</h4>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span>Filtered Capacity:</span>
                                            <span class="font-bold text-stone-800" id="sim-current-cap">0</span>
                                        </div>
                                        <div class="flex justify-between text-sm">
                                            <span>Filtered Load:</span>
                                            <span class="font-bold text-stone-800" id="sim-current-load">0</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="w-full md:w-1/2 flex flex-col justify-center items-center p-6 bg-slate-900 rounded-2xl text-white relative overflow-hidden">
                                    <!-- Dynamic Impact Card -->
                                    <h3 class="text-sm font-medium text-slate-400 uppercase tracking-widest mb-4">Projected Impact</h3>
                                    
                                    <div class="text-center space-y-2 relative z-10">
                                        <p class="text-5xl font-black" id="sim-hiring-needed">0</p>
                                        <p class="text-sm text-slate-300">New Hires Required</p>
                                    </div>

                                    <div class="mt-8 w-full border-t border-slate-700 pt-4 relative z-10">
                                        <div class="flex justify-between text-xs">
                                            <span class="text-slate-400">Projected Gap:</span>
                                            <span class="font-bold" id="sim-projected-gap">0</span>
                                        </div>
                                        <p class="text-xs text-slate-500 mt-2 italic" id="sim-message">System capacity is stable.</p>
                                    </div>

                                    <!-- Decor -->
                                    <div class="absolute -right-4 -bottom-4 text-slate-800 opacity-50">
                                        <span class="text-9xl">‚öñÔ∏è</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sim Chart -->
                        <div class="bg-white p-6 rounded-xl border border-stone-200 shadow-sm">
                             <h3 class="text-md font-bold text-stone-800 mb-4">Gap Analysis Forecast</h3>
                             <div class="chart-container">
                                <canvas id="simChart"></canvas>
                             </div>
                        </div>
                    </div>

                    <!-- VIEW: BENCH ANALYTICS -->
                    <div id="view-bench" class="space-y-6 hidden">
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-md">
                            <p class="text-sm text-blue-900">
                                <strong>Bench Marketing Focus.</strong> Tracking candidate placement performance using the 3-unit capacity logic.
                            </p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-xl border border-stone-200 shadow-sm flex flex-col items-center justify-center">
                                <h3 class="text-md font-bold text-stone-800 mb-4 w-full text-left">Bench Utilization</h3>
                                <div class="relative w-48 h-48">
                                    <canvas id="benchGauge"></canvas>
                                    <div class="absolute inset-0 flex items-center justify-center flex-col pointer-events-none">
                                        <span class="text-3xl font-bold text-stone-800" id="bench-percent">0%</span>
                                        <span class="text-xs text-stone-500">Placed</span>
                                    </div>
                                </div>
                            </div>

                            <div class="md:col-span-2 bg-white p-6 rounded-xl border border-stone-200 shadow-sm">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-md font-bold text-stone-800">Bench Aging & Distribution</h3>
                                </div>
                                <div class="chart-container">
                                    <canvas id="benchBarChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl border border-stone-200 shadow-sm">
                             <div class="p-6 border-b border-stone-100">
                                <h3 class="text-md font-bold text-stone-800">Bench Roster Summary</h3>
                            </div>
                            <div class="p-6">
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                                    <div class="p-4 bg-stone-50 rounded-lg">
                                        <p class="text-xs text-stone-500 uppercase">Total Candidates</p>
                                        <p class="text-xl font-bold text-stone-800 mt-1" id="bench-total">0</p>
                                    </div>
                                    <div class="p-4 bg-stone-50 rounded-lg">
                                        <p class="text-xs text-stone-500 uppercase">Active Marketing</p>
                                        <p class="text-xl font-bold text-blue-600 mt-1" id="bench-active">0</p>
                                    </div>
                                    <div class="p-4 bg-stone-50 rounded-lg">
                                        <p class="text-xs text-stone-500 uppercase">Placed</p>
                                        <p class="text-xl font-bold text-emerald-600 mt-1" id="bench-placed">0</p>
                                    </div>
                                    <div class="p-4 bg-stone-50 rounded-lg">
                                        <p class="text-xs text-stone-500 uppercase">Avg Days on Bench</p>
                                        <p class="text-xl font-bold text-stone-800 mt-1">24</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <script>
        // --- 1. DATA GENERATION LOGIC (Replicating the Blueprint) ---

        const branches = ["Hyderabad", "Vijayawada", "Noida", "Bangalore", "Bhopal", "Chennai"];
        const streams = ["Domestic Recruiting", "US IT Recruiting", "Canada Recruiting"];
        const categories = ["Engineering Recruiting", "IT Recruiting", "Bench Sales", "IT Bench Sales"];
        
        // Updated targets based on user requirement: 3 roles per day
        const targets = {
            "Engineering Recruiting": 3, 
            "IT Recruiting": 3,
            "Bench Sales": 3,             
            "IT Bench Sales": 3
        };

        // Mock Database
        let db = {
            employees: [],
            recruitingRoles: [],
            benchCandidates: []
        };

        function generateData() {
            // Generate ~100 Employees
            for (let i = 0; i < 100; i++) {
                const branch = branches[Math.floor(Math.random() * branches.length)];
                const stream = streams[Math.floor(Math.random() * streams.length)];
                const category = categories[Math.floor(Math.random() * categories.length)];
                
                db.employees.push({
                    id: `EMP${i}`,
                    branch,
                    stream,
                    category,
                    capacityPerUnit: targets[category]
                });
            }

            // Generate Loads to create interesting data (some over capacity, some under)
            db.employees.forEach(emp => {
                const targetCap = targets[emp.category];
                // Random load relative to new capacity of 3
                const loadFactor = 0.5 + Math.random() * 1.5; 
                const load = Math.round(targetCap * loadFactor);

                if (emp.category.includes("Bench")) {
                    // Generate Bench Candidates
                    for(let j=0; j<load; j++) {
                        db.benchCandidates.push({
                            branch: emp.branch,
                            status: Math.random() > 0.4 ? "Marketing" : "Placed", // 60% Placed, 40% Marketing
                            category: emp.category
                        });
                    }
                } else {
                    // Generate Recruiting Roles
                    for(let j=0; j<load; j++) {
                        db.recruitingRoles.push({
                            branch: emp.branch,
                            status: Math.random() > 0.3 ? "Open" : "Filled", // 70% Open
                            category: emp.category
                        });
                    }
                }
            });
        }

        generateData();

        // --- 2. STATE MANAGEMENT & METRICS ---

        let currentState = {
            filterBranch: 'All',
            filterStream: 'All',
            simRoles: 0
        };

        // Charts Instances
        let charts = {};

        function getFilteredData() {
            // Filter Employees
            let filteredEmps = db.employees.filter(e => {
                return (currentState.filterBranch === 'All' || e.branch === currentState.filterBranch) &&
                       (currentState.filterStream === 'All' || e.stream === currentState.filterStream);
            });

            // Calculate Metrics per Employee Grouping
            let totalRecruiters = filteredEmps.length;
            let totalCapacity = 0;
            let currentLoad = 0;

            // Aggregation by Branch for Charts
            let branchAgg = {};
            branches.forEach(b => branchAgg[b] = { cap: 0, load: 0 });

            // Aggregation for Matrix
            let matrixData = []; // { branch, stream, category, headcount, cap, load, gap }

            // Helper to find load count
            const getLoad = (branch, category) => {
                if (category.includes("Bench")) {
                    return db.benchCandidates.filter(c => c.branch === branch && c.category === category && c.status === "Marketing").length;
                } else {
                    return db.recruitingRoles.filter(r => r.branch === branch && r.category === category && r.status === "Open").length;
                }
            };

            // Group filteredEmps
            let groups = {};
            filteredEmps.forEach(e => {
                const key = `${e.branch}|${e.stream}|${e.category}`;
                if (!groups[key]) groups[key] = { count: 0, capUnit: e.capacityPerUnit, branch: e.branch, stream: e.stream, category: e.category };
                groups[key].count++;
            });

            for (let key in groups) {
                const g = groups[key];
                const cap = g.count * g.capUnit;
                let rawLoad = getLoad(g.branch, g.category);
                
                const totalEmpsInBranchCat = db.employees.filter(e => e.branch === g.branch && e.category === g.category).length;
                const ratio = g.count / totalEmpsInBranchCat;
                const allocatedLoad = Math.round(rawLoad * ratio);

                totalCapacity += cap;
                currentLoad += allocatedLoad;

                branchAgg[g.branch].cap += cap;
                branchAgg[g.branch].load += allocatedLoad;

                matrixData.push({
                    branch: g.branch,
                    stream: g.stream,
                    category: g.category,
                    headcount: g.count,
                    capacity: cap,
                    load: allocatedLoad,
                    gap: cap - allocatedLoad
                });
            }

            // Bench Specifics
            let benchTotal = db.benchCandidates.filter(c => (currentState.filterBranch === 'All' || c.branch === currentState.filterBranch)).length;
            let benchActive = db.benchCandidates.filter(c => (currentState.filterBranch === 'All' || c.branch === currentState.filterBranch) && c.status === "Marketing").length;
            let benchPlaced = db.benchCandidates.filter(c => (currentState.filterBranch === 'All' || c.branch === currentState.filterBranch) && c.status === "Placed").length;


            return {
                totalRecruiters,
                totalCapacity,
                currentLoad,
                gap: totalCapacity - currentLoad,
                branchAgg,
                matrixData,
                benchStats: { total: benchTotal, active: benchActive, placed: benchPlaced }
            };
        }

        // --- 3. UI UPDATES ---

        function init() {
            // Populate Filters
            const branchSel = document.getElementById('branch-select');
            branches.forEach(b => {
                let opt = document.createElement('option');
                opt.value = b;
                opt.innerText = b;
                branchSel.appendChild(opt);
            });

            const streamSel = document.getElementById('stream-select');
            streams.forEach(s => {
                let opt = document.createElement('option');
                opt.value = s;
                opt.innerText = s;
                streamSel.appendChild(opt);
            });

            // Initial Render
            updateDashboard();
        }

        function updateDashboard() {
            // Update State
            currentState.filterBranch = document.getElementById('branch-select').value;
            currentState.filterStream = document.getElementById('stream-select').value;
            currentState.simRoles = parseInt(document.getElementById('roles-slider').value);

            // Get Data
            const metrics = getFilteredData();

            // 1. Update KPIs
            animateValue("kpi-headcount", metrics.totalRecruiters);
            animateValue("kpi-capacity", metrics.totalCapacity);
            animateValue("kpi-load", metrics.currentLoad);
            
            const gapEl = document.getElementById('kpi-gap');
            const gapCard = document.getElementById('kpi-gap-card');
            gapEl.innerText = metrics.gap > 0 ? `+${metrics.gap}` : metrics.gap;
            
            if (metrics.gap < 0) {
                gapCard.classList.remove('border-stone-200');
                gapCard.classList.add('border-rose-200', 'bg-rose-50');
                gapEl.classList.add('text-rose-600');
                gapEl.classList.remove('text-emerald-600', 'text-stone-800');
            } else {
                gapCard.classList.add('border-stone-200');
                gapCard.classList.remove('border-rose-200', 'bg-rose-50');
                gapEl.classList.add('text-emerald-600');
                gapEl.classList.remove('text-rose-600', 'text-stone-800');
            }

            // 2. Update Charts
            renderMainChart(metrics.branchAgg);
            renderPieChart(metrics.totalCapacity, metrics.currentLoad);

            // 3. Update Matrix
            renderMatrix(metrics.matrixData);

            // 4. Update Simulator
            updateSimulator(metrics);

            // 5. Update Bench
            updateBenchView(metrics.benchStats);
        }

        function animateValue(id, value) {
            const el = document.getElementById(id);
            el.innerText = value.toLocaleString();
        }

        function renderMatrix(data) {
            const tbody = document.getElementById('matrix-body');
            tbody.innerHTML = '';
            
            data.sort((a,b) => a.gap - b.gap);

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-stone-50 transition-colors";
                
                let gapClass = row.gap < 0 ? "bg-rose-100 text-rose-700" : "bg-emerald-100 text-emerald-700";
                
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-stone-800">${row.branch}</td>
                    <td class="px-6 py-4 text-stone-500">${row.stream}</td>
                    <td class="px-6 py-4 text-stone-500">${row.category}</td>
                    <td class="px-6 py-4 text-right">${row.headcount}</td>
                    <td class="px-6 py-4 text-right font-medium">${row.capacity}</td>
                    <td class="px-6 py-4 text-right">${row.load}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="px-2 py-1 rounded text-xs font-bold ${gapClass}">${row.gap}</span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 4. CHARTS IMPLEMENTATION ---

        function renderMainChart(branchAgg) {
            const ctx = document.getElementById('mainBarChart').getContext('2d');
            
            const labels = Object.keys(branchAgg);
            const capData = labels.map(l => branchAgg[l].cap);
            const loadData = labels.map(l => branchAgg[l].load);

            if (charts.mainBar) charts.mainBar.destroy();

            charts.mainBar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Capacity',
                            data: capData,
                            backgroundColor: '#a5b4fc', // Indigo 300
                            borderRadius: 4
                        },
                        {
                            label: 'Current Load',
                            data: loadData,
                            backgroundColor: '#4f46e5', // Indigo 600
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f5f5f4' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function renderPieChart(capacity, load) {
            const ctx = document.getElementById('utilizationPieChart').getContext('2d');
            const free = Math.max(0, capacity - load);
            const used = Math.min(capacity, load);
            const overload = Math.max(0, load - capacity);

            if (charts.pie) charts.pie.destroy();

            charts.pie = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Utilized', 'Available', 'Overload'],
                    datasets: [{
                        data: [used, free, overload],
                        backgroundColor: ['#4f46e5', '#e2e8f0', '#e11d48'], 
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // --- 5. SIMULATOR LOGIC ---

        document.getElementById('roles-slider').addEventListener('input', function(e) {
            document.getElementById('slider-value-display').innerText = `+${e.target.value} Roles`;
            updateDashboard(); 
        });

        function updateSimulator(metrics) {
            const newGap = metrics.gap - currentState.simRoles;
            
            // Calc avg capacity (Fixed at 3 roles based on user input)
            const avgCap = 3;

            const hiringNeeded = newGap < 0 ? Math.ceil(Math.abs(newGap) / avgCap) : 0;

            document.getElementById('sim-current-cap').innerText = metrics.totalCapacity;
            document.getElementById('sim-current-load').innerText = metrics.currentLoad;
            
            const simGapEl = document.getElementById('sim-projected-gap');
            simGapEl.innerText = newGap;
            simGapEl.className = newGap < 0 ? "font-bold text-rose-400" : "font-bold text-emerald-400";

            document.getElementById('sim-hiring-needed').innerText = hiringNeeded;
            
            const msgEl = document.getElementById('sim-message');
            if (hiringNeeded > 0) {
                msgEl.innerText = `Warning: Capacity breach. Hiring required to sustain +${currentState.simRoles} roles at 3 roles/recruiter.`;
                msgEl.className = "text-xs text-rose-300 mt-2 italic";
            } else {
                msgEl.innerText = "Current headcount can handle this load within the 3-role daily limit.";
                msgEl.className = "text-xs text-emerald-300 mt-2 italic";
            }

            renderSimChart(metrics.totalCapacity, metrics.currentLoad, currentState.simRoles);
        }

        function renderSimChart(cap, load, added) {
            const ctx = document.getElementById('simChart').getContext('2d');
            if (charts.sim) charts.sim.destroy();

            charts.sim = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Current State', 'Projected State'],
                    datasets: [
                        {
                            label: 'Total Load',
                            data: [load, load + added],
                            backgroundColor: [
                                (load > cap) ? '#e11d48' : '#4f46e5', 
                                (load + added > cap) ? '#e11d48' : '#4f46e5'
                            ],
                            barPercentage: 0.5
                        },
                        {
                            label: 'Capacity Limit', 
                            data: [cap, cap],
                            type: 'line',
                            borderColor: '#10b981', 
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // --- 6. BENCH ANALYTICS ---

        function updateBenchView(stats) {
            document.getElementById('bench-total').innerText = stats.total;
            document.getElementById('bench-active').innerText = stats.active;
            document.getElementById('bench-placed').innerText = stats.placed;

            let utilPercent = stats.total > 0 ? Math.round((stats.placed / stats.total) * 100) : 0;
            document.getElementById('bench-percent').innerText = `${utilPercent}%`;

            renderBenchGauge(stats.placed, stats.active);
            renderBenchBar(); 
        }

        function renderBenchGauge(placed, active) {
            const ctx = document.getElementById('benchGauge').getContext('2d');
            if (charts.benchGauge) charts.benchGauge.destroy();

            charts.benchGauge = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Placed', 'Marketing'],
                    datasets: [{
                        data: [placed, active],
                        backgroundColor: ['#10b981', '#3b82f6'], 
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '80%',
                    plugins: { legend: { display: false }, tooltip: { enabled: true } }
                }
            });
        }

        function renderBenchBar() {
            const ctx = document.getElementById('benchBarChart').getContext('2d');
            if (charts.benchBar) charts.benchBar.destroy();

            charts.benchBar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-15 Days', '16-30 Days', '31-45 Days', '45+ Days'],
                    datasets: [{
                        label: 'Candidates Count',
                        data: [12, 19, 8, 5], 
                        backgroundColor: '#3b82f6',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // --- NAVIGATION ---
        function switchTab(tabId) {
            ['overview', 'planner', 'bench'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                const btn = document.getElementById(`nav-${t}`);
                if(t === tabId) {
                    btn.classList.add('bg-indigo-50', 'text-indigo-700');
                    btn.classList.remove('text-stone-600', 'hover:bg-stone-50');
                } else {
                    btn.classList.remove('bg-indigo-50', 'text-indigo-700');
                    btn.classList.add('text-stone-600', 'hover:bg-stone-50');
                }
            });
            document.getElementById(`view-${tabId}`).classList.remove('hidden');

            const titles = {
                'overview': 'Operations Overview',
                'planner': 'Bandwidth Planner',
                'bench': 'Bench Analytics'
            };
            document.getElementById('page-title').innerText = titles[tabId];

            updateDashboard();
        }

        function toggleMobileMenu() {
            const aside = document.querySelector('aside');
            aside.classList.toggle('hidden');
            aside.classList.toggle('fixed');
            aside.classList.toggle('inset-0');
            aside.classList.toggle('bg-white');
            aside.classList.toggle('z-50');
        }

        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
